<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Schedule - Smart Scheduling System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body>
  <div id="sidebar-overlay" class="sidebar-overlay" aria-hidden="true"></div>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation"></aside>
    <main class="main-content">
      <header class="topbar" id="topbar"></header>
      <div id="access-denied-section" class="access-denied-container" style="display: none;">
        <i class="bi bi-shield-x" aria-hidden="true"></i>
        <h2>Access Denied</h2>
        <p>You do not have permission to view this page.</p>
        <a href="dashboard.html" class="btn btn-primary">Go to Dashboard</a>
      </div>
      <div id="main-content-area" class="page-content">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-4">
          <h1 class="h4 mb-0" id="page-title">My Schedule</h1>
          <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-outline-primary btn-sm" id="btn-availability" style="display: none;"><i class="bi bi-clock"></i> My Availability</button>
            <a href="therapist-directory.html" class="btn btn-primary btn-sm" id="btn-book-new" style="display: none;"><i class="bi bi-plus"></i> Book New Session</a>
          </div>
        </div>

        <!-- Filters -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-3">
                <label class="form-label small mb-0">Status</label>
                <select class="form-select form-select-sm" id="filter-status" aria-label="Filter by status">
                  <option value="">All</option>
                  <option value="BOOKED">Booked</option>
                  <option value="PENDING">Pending</option>
                  <option value="COMPLETED">Completed</option>
                  <option value="CANCELLED">Cancelled</option>
                </select>
              </div>
              <div class="col-12 col-md-2">
                <label class="form-label small mb-0">From</label>
                <input type="date" class="form-control form-control-sm" id="filter-from" aria-label="Date from">
              </div>
              <div class="col-12 col-md-2">
                <label class="form-label small mb-0">To</label>
                <input type="date" class="form-control form-control-sm" id="filter-to" aria-label="Date to">
              </div>
              <div class="col-12 col-md-2">
                <button type="button" class="btn btn-primary btn-sm w-100" id="btn-apply-filters">Apply</button>
              </div>
              <div class="col-12 col-md-2">
                <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="btn-clear-filters">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Sessions table (desktop) / cards (mobile) -->
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
            <span id="schedule-list-title">Sessions</span>
            <input type="search" class="form-control form-control-sm w-auto" id="search-sessions" placeholder="Search..." aria-label="Search sessions" style="max-width: 200px;">
          </div>
          <div class="card-body p-0">
            <div class="table-responsive table-responsive-cards">
              <table class="table table-hover mb-0" id="sessions-table">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th id="th-party">With</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="sessions-tbody">
                  <tr><td colspan="5" class="text-center text-muted py-4">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Availability section (therapist only) -->
        <div class="card mt-4" id="availability-card" style="display: none;">
          <div class="card-header">My Availability</div>
          <div class="card-body">
            <form id="form-availability" class="row g-2 mb-3">
              <div class="col-12 col-md-2">
                <label class="form-label small mb-0">Day</label>
                <select class="form-select form-select-sm" name="dayOfWeek" required>
                  <option value="1">Monday</option>
                  <option value="2">Tuesday</option>
                  <option value="3">Wednesday</option>
                  <option value="4">Thursday</option>
                  <option value="5">Friday</option>
                  <option value="6">Saturday</option>
                  <option value="0">Sunday</option>
                </select>
              </div>
              <div class="col-12 col-md-2">
                <label class="form-label small mb-0">Start</label>
                <input type="time" class="form-control form-control-sm" name="startTime" required>
              </div>
              <div class="col-12 col-md-2">
                <label class="form-label small mb-0">End</label>
                <input type="time" class="form-control form-control-sm" name="endTime" required>
              </div>
              <div class="col-12 col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm">Add slot</button>
              </div>
            </form>
            <ul class="availability-list list-unstyled mb-0" id="availability-list"></ul>
          </div>
        </div>
      </div>
    </main>
  </div>
  <button type="button" class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle menu"><i class="bi bi-list"></i></button>

  <!-- Modal: session details / actions -->
  <div class="modal fade" id="modal-session" tabindex="-1" aria-labelledby="modal-session-title" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-session-title">Session details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modal-session-body"></div>
        <div class="modal-footer" id="modal-session-footer"></div>
      </div>
    </div>
  </div>

  <script src="assets/js/validators.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const role = Auth.getRole();
      const userId = Auth.getUserId();
      const isTherapist = role === 'THERAPIST';
      const isClient = role === 'CLIENT';
      const isAdmin = role === 'ADMIN';

      if (isTherapist) {
        document.getElementById('page-title').textContent = 'My Schedule';
        document.getElementById('btn-availability').style.display = 'inline-block';
        document.getElementById('schedule-list-title').textContent = 'My Sessions';
        document.getElementById('th-party').textContent = 'Client';
      } else if (isClient) {
        document.getElementById('page-title').textContent = 'My Schedule';
        document.getElementById('btn-book-new').style.display = 'inline-block';
        document.getElementById('schedule-list-title').textContent = 'My Bookings';
        document.getElementById('th-party').textContent = 'Therapist';
      } else {
        document.getElementById('page-title').textContent = 'Schedules';
        document.getElementById('schedule-list-title').textContent = 'All sessions';
        document.getElementById('th-party').textContent = 'Therapist / Client';
      }

      let allSessions = [];

      function statusClass(s) {
        const v = (s || '').toUpperCase();
        if (v === 'BOOKED' || v === 'PENDING') return 'booked';
        if (v === 'COMPLETED') return 'completed';
        if (v === 'CANCELLED') return 'cancelled';
        return 'pending';
      }

      function renderRow(s) {
        const party = isTherapist ? s.clientName : (isAdmin ? s.therapistName + ' / ' + s.clientName : s.therapistName);
        const status = (s.status || 'BOOKED').toUpperCase();
        const actions = [];
        if (status === 'BOOKED' || status === 'PENDING') {
          if (isClient) {
            actions.push('<button type="button" class="btn btn-sm btn-outline-primary me-1 btn-reschedule" data-id="' + s.id + '">Reschedule</button>');
            actions.push('<button type="button" class="btn btn-sm btn-outline-danger btn-cancel" data-id="' + s.id + '">Cancel</button>');
          }
          if (isTherapist) {
            actions.push('<button type="button" class="btn btn-sm btn-outline-success me-1 btn-complete" data-id="' + s.id + '">Mark completed</button>');
            actions.push('<button type="button" class="btn btn-sm btn-outline-danger btn-cancel" data-id="' + s.id + '">Cancel</button>');
          }
          if (isAdmin) {
            actions.push('<button type="button" class="btn btn-sm btn-outline-success me-1 btn-complete" data-id="' + s.id + '">Complete</button>');
            actions.push('<button type="button" class="btn btn-sm btn-outline-danger btn-cancel" data-id="' + s.id + '">Cancel</button>');
          }
        }
        return '<tr data-id="' + s.id + '">' +
          '<td data-label="Date">' + (s.date || '') + '</td>' +
          '<td data-label="Time">' + (s.time || '') + '</td>' +
          '<td data-label="With">' + (party || '-') + '</td>' +
          '<td data-label="Status"><span class="badge-status ' + statusClass(status) + '">' + status + '</span></td>' +
          '<td data-label="Actions">' + (actions.length ? actions.join(' ') : '-') + '</td></tr>';
      }

      function applyFiltersAndSearch() {
        const status = document.getElementById('filter-status').value;
        const from = document.getElementById('filter-from').value;
        const to = document.getElementById('filter-to').value;
        const q = (document.getElementById('search-sessions').value || '').toLowerCase();
        let list = allSessions;
        if (status) list = list.filter(function (s) { return (s.status || '').toUpperCase() === status; });
        if (from) list = list.filter(function (s) { return (s.date || '') >= from; });
        if (to) list = list.filter(function (s) { return (s.date || '') <= to; });
        if (q) list = list.filter(function (s) {
          return (s.clientName + ' ' + s.therapistName + ' ' + s.date + ' ' + s.time).toLowerCase().indexOf(q) >= 0;
        });
        const tbody = document.getElementById('sessions-tbody');
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No sessions match your filters.</td></tr>';
        } else {
          tbody.innerHTML = list.map(renderRow).join('');
          tbody.querySelectorAll('.btn-cancel').forEach(function (btn) {
            btn.addEventListener('click', function () { cancelSession(this.getAttribute('data-id')); });
          });
          tbody.querySelectorAll('.btn-complete').forEach(function (btn) {
            btn.addEventListener('click', function () { completeSession(this.getAttribute('data-id')); });
          });
          tbody.querySelectorAll('.btn-reschedule').forEach(function (btn) {
            btn.addEventListener('click', function () { rescheduleSession(this.getAttribute('data-id')); });
          });
        }
      }

      function cancelSession(id) {
        if (!confirm('Cancel this session?')) return;
        api.cancelSession(id).then(function () { loadSessions(); }).catch(function () { loadSessions(); });
      }

      function completeSession(id) {
        api.updateSession(id, { status: 'COMPLETED' }).then(function () { loadSessions(); }).catch(function () { loadSessions(); });
      }

      function rescheduleSession(id) {
        alert('Reschedule: In a full app this would open a date/time picker. Session ID: ' + id);
      }

      function loadSessions() {
        getSessionsWithFallback(role, userId).then(function (data) {
          allSessions = data;
          applyFiltersAndSearch();
        });
      }

      document.getElementById('btn-apply-filters').addEventListener('click', applyFiltersAndSearch);
      document.getElementById('btn-clear-filters').addEventListener('click', function () {
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-from').value = '';
        document.getElementById('filter-to').value = '';
        document.getElementById('search-sessions').value = '';
        applyFiltersAndSearch();
      });
      document.getElementById('search-sessions').addEventListener('input', function () { applyFiltersAndSearch(); });

      document.getElementById('btn-availability').addEventListener('click', function () {
        var card = document.getElementById('availability-card');
        card.style.display = card.style.display === 'none' ? 'block' : 'none';
      });

      var availabilityList = [];
      document.getElementById('form-availability').addEventListener('submit', function (e) {
        e.preventDefault();
        var form = e.target;
        var day = form.querySelector('[name="dayOfWeek"]').value;
        var start = form.querySelector('[name="startTime"]').value;
        var end = form.querySelector('[name="endTime"]').value;
        var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        var slotId = 'av-' + Date.now();
        availabilityList.push({ id: slotId, dayOfWeek: parseInt(day, 10), startTime: start, endTime: end });
        var ul = document.getElementById('availability-list');
        var li = document.createElement('li');
        li.className = 'availability-item';
        li.innerHTML = '<span>' + days[parseInt(day, 10)] + ' ' + start + ' â€“ ' + end + '</span><button type="button" class="btn btn-sm btn-outline-danger" data-id="' + slotId + '">Remove</button>';
        li.id = slotId;
        li.querySelector('button').addEventListener('click', function () {
          availabilityList = availabilityList.filter(function (a) { return a.id !== li.id; });
          li.remove();
        });
        ul.appendChild(li);
        form.reset();
      });

      loadSessions();
    })();
  </script>
</body>
</html>
